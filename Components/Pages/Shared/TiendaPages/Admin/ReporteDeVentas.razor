@page "/reporte-ventas"

@using System.Globalization
@using System.Text
@using Microsoft.JSInterop
@using Proyecto_Final.Models.Pedidos 
@using Proyecto_Final.Services

@inject IJSRuntime JSRuntime
@inject IPedidoService PedidoService

<PageTitle>Reporte de Ventas</PageTitle>

<div class="container mx-auto px-4 py-12">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-md border border-gray-200">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Reporte de Ventas</h1>

        <!-- Formulario de filtro por rango de fechas -->
        <form @onsubmit="FilterOrders" class="flex flex-col sm:flex-row gap-4 mb-8 items-end">
            <div class="flex-1 w-full">
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Pedido (Inicio)</label>
                <input type="date" id="startDate" @bind="StartDate" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500">
            </div>
            <div class="flex-1 w-full">
                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Pedido (Fin)</label>
                <input type="date" id="endDate" @bind="EndDate" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500">
            </div>
            <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow transition-colors duration-300">
                Filtrar
            </button>
        </form>

        <!-- Sección de la tabla de pedidos -->
        <div class="overflow-x-auto rounded-lg shadow border border-gray-200">
            <table class="min-w-full bg-white rounded-lg">
                <thead class="bg-gray-200 text-gray-700">
                    <tr>
                        <th class="py-3 px-4 text-left font-semibold text-sm uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 text-left font-semibold text-sm uppercase tracking-wider">Fecha</th>
                        <th class="py-3 px-4 text-left font-semibold text-sm uppercase tracking-wider">Productos</th>
                        <th class="py-3 px-4 text-left font-semibold text-sm uppercase tracking-wider">Total</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    @if (pedidos == null)
                    {
                        <tr><td colspan="4" class="py-4 text-center text-gray-500">Cargando pedidos...</td></tr>
                    }
                    else if (!pedidos.Any())
                    {
                        <tr><td colspan="4" class="py-4 text-center text-gray-500">No se encontraron pedidos en este rango.</td></tr>
                    }
                    else
                    {
                        @foreach (var pedido in pedidos)
                        {
                            // Calcula la cantidad total de productos usando la propiedad 'Detalles'
                            var totalProductos = pedido.Detalles?.Sum(d => d.Cantidad) ?? 0;

                            <tr class="hover:bg-gray-50">
                                <td class="py-3 px-4">@pedido.Id</td>
                                <td class="py-3 px-4">@pedido.FechaPedido.ToString("dd/MM/yyyy")</td>
                                <td class="py-3 px-4">@totalProductos</td>
                                <td class="py-3 px-4">@pedido.Total.ToString("C", new CultureInfo("es-DO"))</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Resumen del reporte -->
        @if (pedidos?.Any() == true)
        {
            var ventasTotales = pedidos.Sum(p => p.Total);
            <div class="mt-8 flex justify-end">
                <div class="p-4 bg-gray-100 rounded-lg shadow">
                    <p class="font-bold text-lg text-gray-800">Total de ventas: <span class="text-green-600">@ventasTotales.ToString("C", new CultureInfo("es-DO"))</span></p>
                </div>
            </div>
        }

        <!-- Botón para generar el reporte de los datos filtrados -->
        <div class="mt-8 text-center">
            <button @onclick="GenerateReport" class="px-8 py-3 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-lg shadow-lg transition-colors duration-300">
                Imprimir Reporte
            </button>
        </div>
    </div>
</div>

@code {
    private List<Pedido>? pedidos;
    private DateTime? StartDate { get; set; }
    private DateTime? EndDate { get; set; }

    protected override async Task OnInitializedAsync()
    {
        pedidos = await PedidoService.ObtenerPedidosEnRangoDeFechas(null, null);
    }

    private async Task FilterOrders()
    {
        pedidos = await PedidoService.ObtenerPedidosEnRangoDeFechas(StartDate, EndDate);
    }

    private async Task GenerateReport()
    {
        var reportHtml = new StringBuilder();

        reportHtml.Append("<!DOCTYPE html><html><head>");
        reportHtml.Append("<title>Reporte de Ventas</title>");
        reportHtml.Append("<style>");
        reportHtml.Append("body { font-family: 'Inter', sans-serif; margin: 2rem; }");
        reportHtml.Append("h1 { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; }");
        reportHtml.Append("h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 0.5rem; }");
        reportHtml.Append("p { text-align: center; font-size: 1rem; color: #6b7280; margin-bottom: 1rem; }");
        reportHtml.Append("table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }");
        reportHtml.Append("th, td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; }");
        reportHtml.Append("thead { background-color: #f3f4f6; }");
        reportHtml.Append("</style>");
        reportHtml.Append("</head><body>");

        reportHtml.Append("<h1>Reporte de Ventas</h1>");
        reportHtml.Append($"<p>Generado el: {DateTime.Now.ToString("dd/MM/yyyy")}</p>");

        if (StartDate.HasValue && EndDate.HasValue)
        {
            reportHtml.Append($"<p>Periodo de filtro: del {StartDate.Value.ToString("dd/MM/yyyy")} al {EndDate.Value.ToString("dd/MM/yyyy")}</p>");
        }

        reportHtml.Append("<h2>Ventas Detalladas</h2>");
        reportHtml.Append("<table>");
        reportHtml.Append("<thead><tr><th>ID</th><th>Fecha</th><th>Productos</th><th>Total</th></tr></thead>");
        reportHtml.Append("<tbody>");

        if (pedidos != null)
        {
            foreach (var pedido in pedidos)
            {
                var totalProductos = pedido.Detalles?.Sum(d => d.Cantidad) ?? 0;
                reportHtml.Append("<tr>");
                reportHtml.Append($"<td>{pedido.Id}</td>");
                reportHtml.Append($"<td>{pedido.FechaPedido.ToString("dd/MM/yyyy")}</td>");
                reportHtml.Append($"<td>{totalProductos}</td>");
                reportHtml.Append($"<td>{pedido.Total.ToString("C", new CultureInfo("es-DO"))}</td>");
                reportHtml.Append("</tr>");
            }
        }
        reportHtml.Append("</tbody></table>");

        if (pedidos?.Any() == true)
        {
            var ventasTotales = pedidos.Sum(p => p.Total);
            reportHtml.Append($"<h2 style='text-align: right; margin-top: 1rem;'>Total de ventas: {ventasTotales.ToString("C", new CultureInfo("es-DO"))}</h2>");
        }

        reportHtml.Append("</body></html>");

        await JSRuntime.InvokeVoidAsync("printReport", reportHtml.ToString());
    }
}
